{% extends "layout/base.html" %}
{% load static %}

{% block title %}My Sessions - {{ custom_user.username }}{% endblock %}

{% block mainsection %}
<div class="container mt-4">
    <div class="row">
        <!-- Page Header -->
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-calendar-check"></i> Session Management</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item active">Sessions</li>
                    </ol>
                </nav>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="col-12 mb-4">
            <div class="row">
                {% if user_has_skills %}
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-1">{{ stats.total_teaching }}</h4>
                                    <p class="mb-0">Teaching Sessions</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-person-video2 fs-2"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-1">{{ stats.total_learning }}</h4>
                                    <p class="mb-0">Learning Sessions</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-person-video3 fs-2"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-1">{{ stats.scheduled_teaching|add:stats.scheduled_learning }}</h4>
                                    <p class="mb-0">Scheduled</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-clock-fill fs-2"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-1">{{ stats.completed_teaching|add:stats.completed_learning }}</h4>
                                    <p class="mb-0">Completed</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-check-circle-fill fs-2"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="col-12">
            <ul class="nav nav-tabs" id="sessionTabs" role="tablist">
                {% if user_has_skills %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="teaching-tab" data-bs-toggle="tab" data-bs-target="#teaching" type="button" role="tab">
                        <i class="bi bi-person-video2"></i> Teaching Sessions ({{ stats.total_teaching }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="learning-tab" data-bs-toggle="tab" data-bs-target="#learning" type="button" role="tab">
                        <i class="bi bi-person-video3"></i> Learning Sessions ({{ stats.total_learning }})
                    </button>
                </li>
                {% else %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="learning-tab" data-bs-toggle="tab" data-bs-target="#learning" type="button" role="tab">
                        <i class="bi bi-person-video3"></i> Learning Sessions ({{ stats.total_learning }})
                    </button>
                </li>
                {% endif %}
            </ul>
        </div>

        <!-- Tab Content -->
        <div class="col-12">
            
            <div class="tab-content" id="sessionTabContent">
                
                <!-- Teaching Sessions Tab -->
                {% if user_has_skills %}
                <div class="tab-pane fade show active" id="teaching" role="tabpanel">
                {% else %}
                <div class="tab-pane fade" id="teaching" role="tabpanel">
                {% endif %}
                <div id="teaching-container">
                    {% include "category_skills/teaching_sessions_grid.html" %}
                </div>
                </div>

                <!-- Learning Sessions Tab -->
                {% if user_has_skills %}
                <div class="tab-pane fade" id="learning" role="tabpanel">
                {% else %}
                <div class="tab-pane fade show active" id="learning" role="tabpanel">
                {% endif %}
                <div id="learning-container">
                    {% include "category_skills/learning_sessions_grid.html" %}
                </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Session Cancellation Modal -->
<div class="modal fade" id="sessionCancellationModal" tabindex="-1" aria-labelledby="sessionCancellationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sessionCancellationModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Cancel Session
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="sessionCancellationForm">
                    {% csrf_token %}
                    <input type="hidden" id="cancellationSessionId" name="session_id">
                    
                    <div class="mb-3">
                        <label for="cancellationReason" class="form-label">Cancellation Reason <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="cancellationReason" name="reason" rows="4" required 
                                  placeholder="Please provide a reason for cancelling this session..." maxlength="500"></textarea>
                        <div class="form-text">This will be shared with the other participant.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitSessionCancellation()">
                    <i class="bi bi-check-lg"></i> Cancel Session
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="feedbackForm" method="POST">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="feedbackModalLabel">
            Leave Feedback for <span id="feedbackRole"></span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="feedbackSessionId" name="session_id">
          
          <!-- Rating -->
          <div class="mb-3">
            <label class="form-label">Give Rating</label>
            <select name="rating" class="form-select" required>
              <option value="">Select rating</option>
              <option value="1">⭐ 1</option>
              <option value="2">⭐ 2</option>
              <option value="3">⭐ 3</option>
              <option value="4">⭐ 4</option>
              <option value="5">⭐ 5</option>
            </select>
          </div>

          <!-- Feedback -->
          <div class="mb-3">
            <label class="form-label">Feedback About the Session</label>
            <textarea name="feedback" class="form-control" rows="4" maxlength="500"
                      placeholder="Write your feedback..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Submit Feedback</button>
        </div>
      </div>
    </form>
  </div>
</div>
>

{% endblock %}

{% block extra_js %}
<script src="{% static 'assets/js/category_skills/session.js' %}"></script>

<!-- Add CSRF token for AJAX requests -->
{% csrf_token %}
{% endblock %}
